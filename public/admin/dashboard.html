<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Crypto POS</title>
    <link rel="icon" type="image/png" href="../logo.png">
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <div class="admin-header">
        <div class="header-left">
            <img src="../logo.png" alt="Logo" class="logo">
            <h1>Crypto POS Admin</h1>
        </div>
        <div class="admin-nav">
            <a href="/admin" class="active">Dashboard</a>
            <a href="/admin/coins">Coins</a>
            <a href="/admin/payments">Payments</a>
            <a href="/" target="_blank">POS View</a>
            <button class="btn btn-secondary" onclick="logout()" style="margin-left: 10px;">Logout</button>
        </div>
    </div>

    <div class="admin-container">
        <h2 style="margin-bottom: 20px;">Dashboard Overview</h2>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Payments</h3>
                <div class="value" id="totalPayments">-</div>
            </div>
            <div class="stat-card">
                <h3>Confirmed Payments</h3>
                <div class="value" id="confirmedPayments">-</div>
            </div>
            <div class="stat-card">
                <h3>Pending Payments</h3>
                <div class="value" id="pendingPayments">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Amount</h3>
                <div class="value" id="totalAmount">-</div>
            </div>
            <div class="stat-card">
                <h3>Enabled Coins</h3>
                <div class="value" id="enabledCoins">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Coins</h3>
                <div class="value" id="totalCoins">-</div>
            </div>
        </div>

        <div class="table-container" style="margin-top: 30px;">
            <h3 style="padding: 20px; margin: 0; border-bottom: 1px solid #e9ecef;">Recent Payments</h3>
            <div id="recentPayments" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        // Check authentication
        fetch('/api/admin/auth/status', { credentials: 'include' })
            .then(res => {
                if (!res.ok) {
                    // If auth check fails, redirect to login
                    window.location.href = '/admin/login';
                    return;
                }
                return res.json();
            })
            .then(data => {
                if (!data || !data.authenticated) {
                    window.location.href = '/admin/login';
                } else {
                    loadDashboard();
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/admin/login';
            });

        async function loadDashboard() {
            try {
                const [statsRes, paymentsRes] = await Promise.all([
                    fetch('/api/admin/stats', { credentials: 'include' }),
                    fetch('/api/admin/payments?limit=10', { credentials: 'include' })
                ]);

                // Check if responses are OK
                if (!statsRes.ok) {
                    const errorData = await statsRes.json().catch(() => ({ error: 'Failed to load stats' }));
                    if (statsRes.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(errorData.error || `Stats API error: ${statsRes.status}`);
                }

                if (!paymentsRes.ok) {
                    const errorData = await paymentsRes.json().catch(() => ({ error: 'Failed to load payments' }));
                    if (paymentsRes.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(errorData.error || `Payments API error: ${paymentsRes.status}`);
                }

                const stats = await statsRes.json();
                const paymentsData = await paymentsRes.json();

                // Validate response data
                if (!stats || !stats.payments) {
                    throw new Error('Invalid stats response format');
                }

                // Update stats
                document.getElementById('totalPayments').textContent = stats.payments.total || 0;
                document.getElementById('confirmedPayments').textContent = stats.payments.confirmed || 0;
                document.getElementById('pendingPayments').textContent = stats.payments.pending || 0;
                document.getElementById('totalAmount').textContent = formatAmount(stats.payments.totalAmount);
                document.getElementById('enabledCoins').textContent = stats.coins?.enabled || 0;
                document.getElementById('totalCoins').textContent = stats.coins?.total || 0;

                // Display recent payments
                const paymentsContainer = document.getElementById('recentPayments');
                if (paymentsData.payments && paymentsData.payments.length > 0) {
                    paymentsContainer.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Payment ID</th>
                                    <th>Coin</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${paymentsData.payments.map(p => `
                                    <tr>
                                        <td>${p.payment_id ? p.payment_id.substring(0, 20) + '...' : 'N/A'}</td>
                                        <td>${p.symbol || p.coin_name || 'N/A'}</td>
                                        <td>${p.amount || 0} ${p.symbol || ''}</td>
                                        <td><span class="status-badge status-${p.status || 'pending'}">${p.status || 'pending'}</span></td>
                                        <td>${p.created_at ? new Date(p.created_at).toLocaleString() : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    paymentsContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No payments yet</div>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                const paymentsContainer = document.getElementById('recentPayments');
                paymentsContainer.innerHTML = `<div style="padding: 40px; text-align: center; color: #d32f2f;">
                    <strong>Error loading dashboard:</strong><br>
                    ${error.message || 'Unknown error occurred'}
                    <br><br>
                    <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                </div>`;
            }
        }

        function formatAmount(amount) {
            if (!amount) return '0.00';
            return parseFloat(amount).toFixed(2);
        }

        function logout() {
            fetch('/api/admin/logout', { method: 'POST', credentials: 'include' })
                .then(() => {
                    window.location.href = '/admin/login';
                });
        }

        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>

</html>